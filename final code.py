# -*- coding: utf-8 -*-
"""
ุชุทุจูู Streamlit ููุญุงุณุจุฉ ุงููุงููุฉ ุงููุชูุฏูุฉ.

ูููุฑ ูุฐุง ุงูุชุทุจูู ูุงุฌูุฉ ูุญุณุงุจ ุงููุงุฆุฏุฉ ุงูุจุณูุทุฉุ ุงููุงุฆุฏุฉ ุงููุฑูุจุฉุ ูุงููุงุฆุฏุฉ ุงููุฑูุจุฉ ุงููุณุชูุฑุฉุ
ุจุงูุฅุถุงูุฉ ุฅูู ุชุญููู ุงุณุชููุงู ุงููุฑูุถ (Amortization Schedule) ูุน ุฑุณูู ุจูุงููุฉ ุชูุถูุญูุฉ.
"""
import streamlit as st
import math
import pandas as pd
from typing import Callable, Dict, Tuple, List

# --------------------------------
# 1. ุฅุนุฏุงุฏุงุช ุงูุตูุญุฉ ูุชุญููู ุงูุฃููุงุท (CSS)
# --------------------------------

# ุฅุนุฏุงุฏ ุงูุตูุญุฉ
st.set_page_config(
    page_title="ุงูุญุงุณุจุฉ ุงููุงููุฉ ุงููุชูุฏูุฉ",
    layout="centered",
    initial_sidebar_state="collapsed"
)

def load_css(file_name: str):
    """ุชุญููู ููู ุงูุฃููุงุท CSS ุฎุงุฑุฌู ูุชุทุจููู ุนูู ุงูุชุทุจูู."""
    try:
        # ุชุฃูุฏ ูู ุฃู ููู style.css ููุฌูุฏ ูู ููุณ ูุฌูุฏ app.py
        with open(file_name, encoding="utf-8") as f:
            st.markdown(f"<style>{f.read()}</style>", unsafe_allow_html=True)
    except FileNotFoundError:
        # ูู ุญุงู ุนุฏู ูุฌูุฏ ุงููููุ ูุณุชุฎุฏู ุฃููุงุท ุงูุชุฑุงุถูุฉ
        st.warning("ููู final style.css ุบูุฑ ููุฌูุฏ. ุณูุชู ุงุณุชุฎุฏุงู ุงูุฃููุงุท ุงูุงูุชุฑุงุถูุฉ.")
        st.markdown("""
        <style>
        /* ุฃููุงุท ุงูุชุฑุงุถูุฉ ุจุณูุทุฉ ูู ุญุงู ุนุฏู ูุฌูุฏ ููู CSS */
        div.stButton > button:nth-child(2) { background-color: #8B0000; color: white; }
        div.stButton > button:first-child { background-color: #0044CC; color: white; }
        </style>
        """, unsafe_allow_html=True)

# ุชุญููู ุงูุฃููุงุท ูู ููู style.css
load_css("final style.css")

# --------------------------------
# 2. ุงูุฏูุงู ุงูุฑูุงุถูุฉ ูุงููุงููุฉ ุงูุฃุณุงุณูุฉ
# --------------------------------

def fmt(x: float) -> str:
    """ุชูุณูู ุงูุฑูู ูุนููุฉ ูุน ูุงุตูุฉ ุงูุขูุงู ูุจุฏูุฉ ุนุดุฑูุฉ."""
    return f"{x:,.2f}"

def simple_interest(P: float, r: float, t_months: int) -> Tuple[float, float]:
    """
    ุญุณุงุจ ุงููุงุฆุฏุฉ ุงูุจุณูุทุฉ ูุงููุจูุบ ุงูููุงุฆู.
    A = P * (1 + r * t)
    """
    t_years = t_months / 12.0
    A = P * (1 + r * t_years)
    I = A - P
    return I, A

def compound_interest(P: float, r: float, t_months: int, m: int) -> Tuple[float, float]:
    """
    ุญุณุงุจ ุงููุงุฆุฏุฉ ุงููุฑูุจุฉ (ูุชูุทุนุฉ).
    A = P * (1 + r/m)^(m*t)
    """
    t_years = t_months / 12.0
    # ุชุฌูุจ ุงูุฃุฎุทุงุก ุงูุฑูุงุถูุฉ ูู ุญุงู ูุงูุช ุงููุฏุฉ ุตูุฑ
    if t_years == 0:
        return 0.0, P
    A = P * ((1 + r / m) ** (m * t_years))
    I = A - P
    return I, A

def continuous_compound(P: float, r: float, t_months: int) -> Tuple[float, float]:
    """
    ุญุณุงุจ ุงููุงุฆุฏุฉ ุงููุฑูุจุฉ ุงููุณุชูุฑุฉ.
    A = P * e^(r*t)
    """
    t_years = t_months / 12.0
    A = P * math.exp(r * t_years)
    I = A - P
    return I, A

def monthly_payment(P: float, r: float, t_months: int) -> float:
    """
    ุชุญุณุจ ุงููุณุท ุงูุดูุฑู ุงูุซุงุจุช (PMT) ูููุฑุถ.
    """
    if t_months <= 0:
        return P # ูู ุญุงู ุนุฏู ูุฌูุฏ ูุฏุฉุ ุงููุณุท ูู ุงููุจูุบ ุงูุฃุตูู (ุญุงูุฉ ุบูุฑ ูุงูุนูุฉ)
    
    i = r / 12.0 # ุณุนุฑ ุงููุงุฆุฏุฉ ุงูุดูุฑู
    
    if i == 0:
        # ุชุฌูุจ ุงููุณูุฉ ุนูู ุตูุฑ ูู ุญุงู ูุงูุช ุงููุงุฆุฏุฉ ุตูุฑ
        return P / t_months
    
    # ุตูุบุฉ ุงููุณุท ุงูุดูุฑู (PMT)
    # M = P * [i(1 + i)^n] / [(1 + i)^n - 1]
    return P * i / (1 - (1 + i) ** -t_months)

def amortization_schedule(P: float, r: float, t_months: int) -> pd.DataFrame:
    """
    ุชูุดุฆ ุฌุฏูู ุงุณุชููุงู ุงููุฑุถ (Amortization Schedule) ุดูุฑุงู ุจุดูุฑ.
    """
    monthly_rate = r / 12.0
    payment = monthly_payment(P, r, t_months)
    
    schedule_data = []
    remaining_balance = P
    
    # ุญููุฉ ุชูุฑุงุฑูุฉ (Loop) ุชูุซู ุงูุชุญููู ุงูุนุฏุฏู ุดูุฑุงู ุจุดูุฑ
    for month in range(1, t_months + 1):
        # 1. ุญุณุงุจ ุงููุงุฆุฏุฉ ููุฐุง ุงูุดูุฑ
        interest_paid = remaining_balance * monthly_rate
        
        # 2. ุญุณุงุจ ุฃุตู ุงูุฏูู ุงููุณุฏุฏ
        principal_paid = payment - interest_paid
        
        # 3. ุชุญุฏูุซ ุงูุฑุตูุฏ ุงููุชุจูู
        remaining_balance -= principal_paid
        
        # ูุนุงูุฌุฉ ุงูุดูุฑ ุงูุฃุฎูุฑ (ูุถูุงู ุฃู ุงูุฑุตูุฏ ูุตุจุญ ุตูุฑุงู ุชูุงูุงู)
        if month == t_months:
            # ุชุนุฏูู ุจุณูุท ูุถูุงู ุฃู ุงูุฑุตูุฏ ุงูููุงุฆู ุตูุฑ
            principal_paid += remaining_balance
            remaining_balance = 0.0
        elif remaining_balance < 0:
            # ูุนุงูุฌุฉ ุญุงูุฉ ุงูุชูุฑูุจ ุงูุชู ูุฏ ุชุฌุนู ุงูุฑุตูุฏ ุณุงูุจุงู ูุจู ุงูุดูุฑ ุงูุฃุฎูุฑ
            principal_paid += remaining_balance
            remaining_balance = 0.0
        
        # ุฅุถุงูุฉ ุจูุงูุงุช ุงูุดูุฑ ุฅูู ุงููุงุฆูุฉ
        schedule_data.append({
            "ุงูุดูุฑ": month,
            "ุงููุณุท ุงูุดูุฑู": payment,
            "ุงููุงุฆุฏุฉ ุงููุฏููุนุฉ": interest_paid,
            "ุฃุตู ุงูุฏูู ุงููุณุฏุฏ": principal_paid,
            "ุงูุฑุตูุฏ ุงููุชุจูู": remaining_balance
        })
            
    # ุฅูุดุงุก DataFrame
    df = pd.DataFrame(schedule_data)
    
    # ุชูุณูู ุงูุฃุนูุฏุฉ
    for col in ["ุงููุณุท ุงูุดูุฑู", "ุงููุงุฆุฏุฉ ุงููุฏููุนุฉ", "ุฃุตู ุงูุฏูู ุงููุณุฏุฏ", "ุงูุฑุตูุฏ ุงููุชุจูู"]:
        df[col] = df[col].apply(lambda x: round(x, 2))
        
    return df

# --------------------------------
# 3. ุจููุฉ ุงูุนูููุงุช (Configuration)
# --------------------------------

CALCULATION_MODES = {
    "ุงููุงุฆุฏุฉ ุงูุจุณูุทุฉ": {
        "description": "ุชุญุณุจ ุงููุงุฆุฏุฉ ุนูู ุงูุฃุตู ููุท.",
        "func": simple_interest,
        "params": ["P", "r", "t_months"],
        "result_labels": ("ุฅุฌูุงูู ุงููุงุฆุฏุฉ", "ุงููุจูุบ ุงูููุงุฆู")
    },
    "ุงููุงุฆุฏุฉ ุงููุฑูุจุฉ (ูุชูุทุนุฉ)": {
        "description": "ุชูุถุงู ุงููุงุฆุฏุฉ ููุฃุตู ุนูู ุฏูุนุงุช ุฎูุงู ุงูุณูุฉ.",
        "func": compound_interest,
        "params": ["P", "r", "t_months", "m"],
        "result_labels": ("ุฅุฌูุงูู ุงููุงุฆุฏุฉ", "ุงููุจูุบ ุงูููุงุฆู")
    },
    "ุงููุงุฆุฏุฉ ุงููุฑูุจุฉ ุงููุณุชูุฑุฉ": {
        "description": "ุงููุงุฆุฏุฉ ุชูุญุณุจ ุจุดูู ูุณุชูุฑ ุจุงุณุชุฎุฏุงู ุงูุฃุณุณ.",
        "func": continuous_compound,
        "params": ["P", "r", "t_months"],
        "result_labels": ("ุฅุฌูุงูู ุงููุงุฆุฏุฉ", "ุงููุจูุบ ุงูููุงุฆู")
    },
    "ุงููุณุท ุงูุดูุฑู ูููุฑุถ (ุชุญููู ุงูุงุณุชููุงู)": {
        "description": "ูุญุณุจ ุงููุณุท ุงูุดูุฑู ูููุฏู ุฌุฏูู ุงุณุชููุงู ุชูุตููู ูููุฑุถ.",
        "func": monthly_payment,
        "params": ["P", "r", "t_months"],
        "result_labels": ("ุงููุณุท ุงูุดูุฑู",)
    }
}

# --------------------------------
# 4. ูุงุฌูุฉ ุงููุณุชุฎุฏู ุงูุฑุฆูุณูุฉ (UI)
# --------------------------------

st.title("ุงูุญุงุณุจุฉ ุงููุงููุฉ ุงููุชูุฏูุฉ")

# **ุงูุชุนุฏูู ุงููุทููุจ: ูุถุน ุณุทุฑ (ุทุงูุจุงุช ุฏ.ุฑูู ...) ุฏุงุฎู ูุฑุจุน ุฃุฒุฑู**
# ุงุณุชุฎุฏุงู st.info() ูุฅูุดุงุก ูุฑุจุน ุฅุฎุจุงุฑู ุฃุฒุฑู
st.info("ุทุงูุจุงุช ุฏ.ุฑูู ุงููุซุงูู | ููุฑุฑ ุจุฑูุฌุฉ ุฑูุงุถูุฉ")

# ุงุฎุชูุงุฑ ุงูุนูููุฉ
choice = st.selectbox("ุงุฎุชุฑ ุงูุนูููุฉ:", list(CALCULATION_MODES.keys()))
mode_config = CALCULATION_MODES[choice]
st.caption(mode_config["description"])

# ุญููู ุงูุฅุฏุฎุงู
inputs: Dict[str, float | None] = {}
inputs["P"] = st.number_input("ุงููุจูุบ (P):", min_value=0.0, format="%.2f", step=1.0, key="P")
inputs["r_pct"] = st.number_input("ุงููุณุจุฉ ุงูุณูููุฉ (%):", min_value=0.0, format="%.2f", step=1.0, key="r_pct")
inputs["t_months"] = st.number_input("ุงููุฏุฉ (ุจุงูุฃุดูุฑ):", min_value=1, step=1, format="%d", key="t_months")

if "m" in mode_config["params"]:
    inputs["m"] = st.number_input("ุนุฏุฏ ุงูุฏูุนุงุช ูู ุงูุณูุฉ (m):", min_value=1, step=1, format="%d", key="m")

# ุฏุงูุฉ ูุณุญ ุงูุญููู
def clear_fields():
    """ุฅุนุงุฏุฉ ุชุนููู ููู ุญููู ุงูุฅุฏุฎุงู ูู ุญุงูุฉ ุงูุฌูุณุฉ."""
    for key in ["P", "r_pct", "t_months", "m"]:
        if key in st.session_state:
            # ุชุนููู ุงูููู ุงูุงูุชุฑุงุถูุฉ ุงูููุงุณุจุฉ
            st.session_state[key] = 0.0 if key in ['P', 'r_pct'] else 1

# ุฃุฒุฑุงุฑ ุงูุฅุฌุฑุงุกุงุช
col1, col2 = st.columns(2)

with col1:
    calculate_button = st.button("ุงุญุณุจ", type="primary")

with col2:
    st.button("ูุณุญ ุงูุญููู", on_click=clear_fields)

# --------------------------------
# 5. ููุทู ุงูุญุณุงุจ ูุนุฑุถ ุงููุชุงุฆุฌ
# --------------------------------

if calculate_button:
    # ุงูุชุญูู ูู ุงููุฏุฎูุงุช
    P = inputs["P"]
    r_pct = inputs["r_pct"]
    t_months = int(inputs["t_months"])
    m_val = int(inputs.get("m", 1))

    if P is None or r_pct is None or t_months is None:
        st.error("ูุฑุฌู ุฅุฏุฎุงู ุฌููุน ุงูููู ุงููุทููุจุฉ.")
    elif P < 0 or r_pct < 0 or t_months <= 0:
        st.error("ูุฌุจ ุฃู ุชููู ููู ุงููุจูุบ ูุงููุณุจุฉ ููุฌุจุฉุ ูุงููุฏุฉ ุฃูุจุฑ ูู ุตูุฑ.")
    else:
        r = r_pct / 100.0
        
        func = mode_config["func"]
        params = {"P": P, "r": r, "t_months": t_months}
        if "m" in mode_config["params"]:
            params["m"] = m_val

        # ุชูููุฐ ุฏุงูุฉ ุงูุญุณุงุจ
        result = func(**params)

        # ุนุฑุถ ุงููุชุงุฆุฌ ุจุงุณุชุฎุฏุงู st.metric
        st.subheader("ุงููุชุงุฆุฌ")
        if isinstance(result, tuple):
            # ุนุฑุถ ุงููุชุงุฆุฌ ุฌูุจุงู ุฅูู ุฌูุจ
            cols = st.columns(len(result))
            for i, (label, value) in enumerate(zip(mode_config["result_labels"], result)):
                with cols[i]:
                    st.metric(label=label, value=fmt(value))
        else:
            # ูู ุญุงูุฉ ุงููุณุท ุงูุดูุฑูุ ุงููุชูุฌุฉ ูู ูููุฉ ูุงุญุฏุฉ
            st.metric(label=mode_config["result_labels"][0], value=fmt(result))

        # --------------------------------
        # ุนุฑุถ ุฌุฏูู ุงูุงุณุชููุงู ูุงูุฑุณูู ุงูุจูุงููุฉ
        # --------------------------------
        if choice == "ุงููุณุท ุงูุดูุฑู ูููุฑุถ (ุชุญููู ุงูุงุณุชููุงู)":
            st.subheader("ุฌุฏูู ุงุณุชููุงู ุงููุฑุถ (Amortization Schedule)")
            
            # ุงุณุชุฏุนุงุก ุงูุฏุงูุฉ ุงูุฌุฏูุฏุฉ
            amort_df = amortization_schedule(P, r, t_months)
            
            # ุนุฑุถ ุงูุฌุฏูู
            st.dataframe(amort_df, use_container_width=True)
            
            # ุนุฑุถ ุงูุฑุณู ุงูุจูุงูู ูุชูุฒูุน ุงููุณุท
            st.subheader("ุชูุฒูุน ุงููุณุท ุงูุดูุฑู (ูุงุฆุฏุฉ ููุงุจู ุฃุตู)")
            
            # ุฅูุดุงุก DataFrame ููุฑุณู ุงูุจูุงูู
            chart_data = amort_df[["ุงูุดูุฑ", "ุงููุงุฆุฏุฉ ุงููุฏููุนุฉ", "ุฃุตู ุงูุฏูู ุงููุณุฏุฏ"]]
            chart_data = chart_data.set_index("ุงูุดูุฑ")
            
            # ุงุณุชุฎุฏุงู st.bar_chart ูุจูุงู ุงูุชูุฒูุน
            st.bar_chart(chart_data)
            
            # ุนุฑุถ ุงูุฑุณู ุงูุจูุงูู ููุฑุตูุฏ ุงููุชุจูู
            st.subheader("ุงูุฑุตูุฏ ุงููุชุจูู ุดูุฑุงู ุจุดูุฑ")
            balance_chart = amort_df[["ุงูุดูุฑ", "ุงูุฑุตูุฏ ุงููุชุจูู"]].set_index("ุงูุดูุฑ")
            st.line_chart(balance_chart)
            
        elif choice != "ุงููุณุท ุงูุดูุฑู ูููุฑุถ (ุชุญููู ุงูุงุณุชููุงู)":
            # ููุทู ุงูุฑุณู ุงูุจูุงูู ููููุงุฆุฏ (ุจุงุณุชุฎุฏุงู st.line_chart)
            st.subheader("ุงูุฑุณู ุงูุจูุงูู ููููู")
            
            # ุชุญุฏูุฏ ุนุฏุฏ ุงูููุงุท ูู ุงูุฑุณู ุงูุจูุงูู (ูุชุญุณูู ุงูุฃุฏุงุก)
            # ูุฎุชุงุฑ 120 ููุทุฉ ูุญุฏ ุฃูุตูุ ุฃู ุนุฏุฏ ุงูุฃุดูุฑ ุฅุฐุง ูุงู ุฃูู
            num_points = min(t_months, 120)
            step = max(1, t_months // num_points)
            
            months_range = list(range(1, t_months + 1, step))
            
            # ุงูุชุฃูุฏ ูู ุฃู ุงูุดูุฑ ุงูุฃุฎูุฑ ููุฌูุฏ
            if t_months not in months_range:
                months_range.append(t_months)
                
            values: List[float] = []

            # ุญุณุงุจ ุงููููุฉ ุงููุชุฑุงููุฉ ููู ุดูุฑ ูู ุงููุทุงู
            for m in months_range:
                if choice == "ุงููุงุฆุฏุฉ ุงูุจุณูุทุฉ":
                    # ูุฃุฎุฐ ุงููุจูุบ ุงูููุงุฆู (ุงูุนูุตุฑ ุงูุซุงูู ูู ุงูุชูุจู)
                    values.append(simple_interest(P, r, m)[1])
                elif choice == "ุงููุงุฆุฏุฉ ุงููุฑูุจุฉ (ูุชูุทุนุฉ)":
                    values.append(compound_interest(P, r, m, m_val)[1])
                elif choice == "ุงููุงุฆุฏุฉ ุงููุฑูุจุฉ ุงููุณุชูุฑุฉ":
                    values.append(continuous_compound(P, r, m)[1])

            chart_data = pd.DataFrame({
                "ุงูุดูุฑ": months_range,
                "ุงููููุฉ ุงููุชุฑุงููุฉ": values
            })
            
            st.line_chart(chart_data.set_index("ุงูุดูุฑ"))

# --------------------------------
# 6. ูุณู ุงููุนูููุงุช ุงูุฅุถุงููุฉ (Footer)
# --------------------------------

st.markdown("---")

# ุฅุฎูุงุก ูุณุคูููุฉ ูุงุถุญ
st.info("๐ก ููุงุญุธุฉ: ูุฐู ุงููุชุงุฆุฌ ูู ุชูุฏูุฑุงุช ุฑูุงุถูุฉ ูุจููุฉ ุนูู ุงููุฏุฎูุงุช. ููุญุตูู ุนูู ุนุฑุถ ูุงูู ุฑุณููุ ูุฑุฌู ุงุณุชุดุงุฑุฉ ูุณุชุดุงุฑ ูุงูู ูุฎุชุต.")

# ุนุฑุถ ุงููุนุงุฏูุงุช ุงูุฑูุงุถูุฉ ุงููุณุชุฎุฏูุฉ
with st.expander("ุงููููุฌูุฉ ูุงููุนุงุฏูุงุช ุงูุฑูุงุถูุฉ ุงููุณุชุฎุฏูุฉ"):
    st.markdown("""
    **1. ุงููุณุท ุงูุดูุฑู ูููุฑุถ (Amortization):**
    ูุชู ุญุณุงุจู ุจุงุณุชุฎุฏุงู ูุนุงุฏูุฉ ุงููุณุท ุงูุซุงุจุช:
    $$
    M = P \\frac{i(1+i)^n}{(1+i)^n - 1}
    $$
    ุญูุซ:
    *   $M$: ุงููุณุท ุงูุดูุฑู
    *   $P$: ุฃุตู ุงููุฑุถ
    *   $i$: ุณุนุฑ ุงููุงุฆุฏุฉ ุงูุดูุฑู (ุงูุณููู ููุณูู ุนูู 12)
    *   $n$: ุนุฏุฏ ุงูุฃุดูุฑ ุงูููู

    **2. ุงููุงุฆุฏุฉ ุงููุฑูุจุฉ (Compound Interest):**
    $$
    A = P \\left(1 + \\frac{r}{m}\\right)^{mt}
    $$
    ุญูุซ:
    *   $A$: ุงููุจูุบ ุงูููุงุฆู
    *   $P$: ุฃุตู ุงููุจูุบ
    *   $r$: ุณุนุฑ ุงููุงุฆุฏุฉ ุงูุณููู
    *   $m$: ุนุฏุฏ ูุฑุงุช ุฅุถุงูุฉ ุงููุงุฆุฏุฉ ูู ุงูุณูุฉ
    *   $t$: ุงููุฏุฉ ุจุงูุณููุงุช

    **3. ุงููุงุฆุฏุฉ ุงููุฑูุจุฉ ุงููุณุชูุฑุฉ (Continuous Compounding):**
    $$
    A = P e^{rt}
    $$
    ุญูุซ:
    *   $A$: ุงููุจูุบ ุงูููุงุฆู
    *   $P$: ุฃุตู ุงููุจูุบ
    *   $e$: ุงูุซุงุจุช ุงูุฑูุงุถู (ูุงุนุฏุฉ ุงูููุบุงุฑูุชู ุงูุทุจูุนู)
    *   $r$: ุณุนุฑ ุงููุงุฆุฏุฉ ุงูุณููู
    *   $t$: ุงููุฏุฉ ุจุงูุณููุงุช

    **4. ุงููุงุฆุฏุฉ ุงูุจุณูุทุฉ (Simple Interest):**
    $$
    A = P(1 + rt)
    $$
    """)

# ูุณู ุงูุญููู ุงูุฃูุงุฏูููุฉ (Footer) - ุชู ูููู ุฅูู CSS ููููู ุฃูุซุฑ ุงุญุชุฑุงููุฉ
# ููุงุญุธุฉ: ุชู ุฅุฒุงูุฉ ุงูููุฏ ุงููุฏูู ูู ููุง ูุฃูู ุชู ุงุณุชุจุฏุงูู ุจู st.info ูู ุงูุฃุนูู.
# ุงูููุฏ ุงููุฏูู:
# st.markdown(
#     """
#     <div class="footer-academic">
#        {CF1} ุทุงูุจุงุช ุฏ.ุฑูู ุงููุซุงูู | ููุฑุฑ ุจุฑูุฌุฉ ุฑูุงุถูุฉ 
#     </div>
#     """,
#     unsafe_allow_html=True
# )
